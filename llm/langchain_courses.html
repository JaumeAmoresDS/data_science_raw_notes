<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>index – .</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0b37c64f34216b628666a8dac638b53b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#state-reducers" id="toc-state-reducers" class="nav-link active" data-scroll-target="#state-reducers">State Reducers</a>
  <ul class="collapse">
  <li><a href="#custom-reducers" id="toc-custom-reducers" class="nav-link" data-scroll-target="#custom-reducers">Custom Reducers</a></li>
  <li><a href="#re-writing" id="toc-re-writing" class="nav-link" data-scroll-target="#re-writing">Re-writing</a></li>
  </ul></li>
  <li><a href="#new-message-to-add" id="toc-new-message-to-add" class="nav-link" data-scroll-target="#new-message-to-add">New message to add</a>
  <ul class="collapse">
  <li><a href="#removal" id="toc-removal" class="nav-link" data-scroll-target="#removal">Removal</a></li>
  </ul></li>
  <li><a href="#multiple-schemas" id="toc-multiple-schemas" class="nav-link" data-scroll-target="#multiple-schemas">Multiple Schemas</a>
  <ul class="collapse">
  <li><a href="#private-state" id="toc-private-state" class="nav-link" data-scroll-target="#private-state">Private State</a></li>
  <li><a href="#input-output-schema" id="toc-input-output-schema" class="nav-link" data-scroll-target="#input-output-schema">Input / Output Schema</a></li>
  </ul></li>
  <li><a href="#trim-filter-messages" id="toc-trim-filter-messages" class="nav-link" data-scroll-target="#trim-filter-messages">Trim / Filter Messages</a>
  <ul class="collapse">
  <li><a href="#reducer" id="toc-reducer" class="nav-link" data-scroll-target="#reducer">Reducer</a></li>
  <li><a href="#filtering-messages" id="toc-filtering-messages" class="nav-link" data-scroll-target="#filtering-messages">Filtering messages</a></li>
  <li><a href="#trim-messages" id="toc-trim-messages" class="nav-link" data-scroll-target="#trim-messages">Trim messages</a></li>
  </ul></li>
  <li><a href="#chatbot-summarization" id="toc-chatbot-summarization" class="nav-link" data-scroll-target="#chatbot-summarization">Chatbot Summarization</a></li>
  <li><a href="#chatbot-with-external-memory" id="toc-chatbot-with-external-memory" class="nav-link" data-scroll-target="#chatbot-with-external-memory">Chatbot with External Memory</a>
  <ul class="collapse">
  <li><a href="#sqlite" id="toc-sqlite" class="nav-link" data-scroll-target="#sqlite">SQLite</a></li>
  </ul></li>
  <li><a href="#ux-and-human-in-the-loop" id="toc-ux-and-human-in-the-loop" class="nav-link" data-scroll-target="#ux-and-human-in-the-loop">UX and Human-in-the-Loop</a></li>
  <li><a href="#streaming-and-interruption" id="toc-streaming-and-interruption" class="nav-link" data-scroll-target="#streaming-and-interruption">Streaming and Interruption</a>
  <ul class="collapse">
  <li><a href="#streaming-modes" id="toc-streaming-modes" class="nav-link" data-scroll-target="#streaming-modes">Streaming modes</a>
  <ul class="collapse">
  <li><a href="#messages-mode" id="toc-messages-mode" class="nav-link" data-scroll-target="#messages-mode">messages mode</a></li>
  </ul></li>
  <li><a href="#langraph-studio" id="toc-langraph-studio" class="nav-link" data-scroll-target="#langraph-studio">Langraph studio</a></li>
  </ul></li>
  <li><a href="#breakpoints" id="toc-breakpoints" class="nav-link" data-scroll-target="#breakpoints">Breakpoints</a>
  <ul class="collapse">
  <li><a href="#breakpoints-with-langgraph-api" id="toc-breakpoints-with-langgraph-api" class="nav-link" data-scroll-target="#breakpoints-with-langgraph-api">Breakpoints with LangGraph API</a>
  <ul class="collapse">
  <li><a href="#langgraph-studio" id="toc-langgraph-studio" class="nav-link" data-scroll-target="#langgraph-studio">Langgraph studio</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#editing-state-and-human-feedback" id="toc-editing-state-and-human-feedback" class="nav-link" data-scroll-target="#editing-state-and-human-feedback">Editing state and human feedback</a>
  <ul class="collapse">
  <li><a href="#update-state-message" id="toc-update-state-message" class="nav-link" data-scroll-target="#update-state-message">Update state / message</a></li>
  <li><a href="#langgraph-studio-1" id="toc-langgraph-studio-1" class="nav-link" data-scroll-target="#langgraph-studio-1">Langgraph studio</a></li>
  <li><a href="#awaiting-user-input" id="toc-awaiting-user-input" class="nav-link" data-scroll-target="#awaiting-user-input">Awaiting user input</a></li>
  </ul></li>
  <li><a href="#dynamic-breakpoints" id="toc-dynamic-breakpoints" class="nav-link" data-scroll-target="#dynamic-breakpoints">Dynamic breakpoints</a>
  <ul class="collapse">
  <li><a href="#conditional" id="toc-conditional" class="nav-link" data-scroll-target="#conditional">Conditional</a></li>
  </ul></li>
  <li><a href="#time-travel" id="toc-time-travel" class="nav-link" data-scroll-target="#time-travel">Time Travel</a>
  <ul class="collapse">
  <li><a href="#replay" id="toc-replay" class="nav-link" data-scroll-target="#replay">Replay</a></li>
  <li><a href="#fork" id="toc-fork" class="nav-link" data-scroll-target="#fork">Fork</a>
  <ul class="collapse">
  <li><a href="#using-langgraph-studio" id="toc-using-langgraph-studio" class="nav-link" data-scroll-target="#using-langgraph-studio">Using Langgraph studio</a></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#building-your-assistant" id="toc-building-your-assistant" class="nav-link" data-scroll-target="#building-your-assistant">Building your assistant</a></li>
  <li><a href="#parallelization" id="toc-parallelization" class="nav-link" data-scroll-target="#parallelization">Parallelization</a>
  <ul class="collapse">
  <li><a href="#control-execution-order-of-parallel-nodes" id="toc-control-execution-order-of-parallel-nodes" class="nav-link" data-scroll-target="#control-execution-order-of-parallel-nodes">Control execution order of parallel nodes</a></li>
  <li><a href="#realistic-example" id="toc-realistic-example" class="nav-link" data-scroll-target="#realistic-example">Realistic example</a></li>
  </ul></li>
  <li><a href="#sub-graphs" id="toc-sub-graphs" class="nav-link" data-scroll-target="#sub-graphs">Sub-graphs</a>
  <ul class="collapse">
  <li><a href="#notes-1" id="toc-notes-1" class="nav-link" data-scroll-target="#notes-1">Notes</a></li>
  </ul></li>
  <li><a href="#map-reduce" id="toc-map-reduce" class="nav-link" data-scroll-target="#map-reduce">Map-Reduce</a>
  <ul class="collapse">
  <li><a href="#using-send-and-conditional-edges" id="toc-using-send-and-conditional-edges" class="nav-link" data-scroll-target="#using-send-and-conditional-edges">Using send and conditional edges</a></li>
  <li><a href="#notes-about-example-used-in-tutorial" id="toc-notes-about-example-used-in-tutorial" class="nav-link" data-scroll-target="#notes-about-example-used-in-tutorial">Notes about example used in tutorial</a>
  <ul class="collapse">
  <li><a href="#implementation-details" id="toc-implementation-details" class="nav-link" data-scroll-target="#implementation-details">Implementation details</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#long-term-memory" id="toc-long-term-memory" class="nav-link" data-scroll-target="#long-term-memory">Long term memory</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#short-vs-long-term-memory" id="toc-short-vs-long-term-memory" class="nav-link" data-scroll-target="#short-vs-long-term-memory">Short vs Long term memory</a></li>
  <li><a href="#long-term-memory-1" id="toc-long-term-memory-1" class="nav-link" data-scroll-target="#long-term-memory-1">Long term memory:</a>
  <ul class="collapse">
  <li><a href="#type-of-memory" id="toc-type-of-memory" class="nav-link" data-scroll-target="#type-of-memory">Type of memory:</a></li>
  <li><a href="#updates" id="toc-updates" class="nav-link" data-scroll-target="#updates">Updates</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#langgraph-store" id="toc-langgraph-store" class="nav-link" data-scroll-target="#langgraph-store">LangGraph Store</a>
  <ul class="collapse">
  <li><a href="#implementation-details-1" id="toc-implementation-details-1" class="nav-link" data-scroll-target="#implementation-details-1">Implementation details</a></li>
  </ul></li>
  <li><a href="#memory-schema-profile" id="toc-memory-schema-profile" class="nav-link" data-scroll-target="#memory-schema-profile">Memory schema + profile</a>
  <ul class="collapse">
  <li><a href="#model-with-structured-output" id="toc-model-with-structured-output" class="nav-link" data-scroll-target="#model-with-structured-output">Model with structured output</a></li>
  <li><a href="#trustcall" id="toc-trustcall" class="nav-link" data-scroll-target="#trustcall">TrustCall</a>
  <ul class="collapse">
  <li><a href="#call" id="toc-call" class="nav-link" data-scroll-target="#call">Call</a></li>
  </ul></li>
  <li><a href="#update" id="toc-update" class="nav-link" data-scroll-target="#update">Update</a></li>
  </ul></li>
  <li><a href="#memory-schema-collection" id="toc-memory-schema-collection" class="nav-link" data-scroll-target="#memory-schema-collection">Memory Schema + Collection</a>
  <ul class="collapse">
  <li><a href="#model-with-structured-output-1" id="toc-model-with-structured-output-1" class="nav-link" data-scroll-target="#model-with-structured-output-1">model with structured output</a></li>
  <li><a href="#trustcall-1" id="toc-trustcall-1" class="nav-link" data-scroll-target="#trustcall-1">TrustCall</a></li>
  <li><a href="#graph-trustcall" id="toc-graph-trustcall" class="nav-link" data-scroll-target="#graph-trustcall">Graph + TrustCall</a></li>
  </ul></li>
  <li><a href="#memory-agent" id="toc-memory-agent" class="nav-link" data-scroll-target="#memory-agent">Memory agent</a>
  <ul class="collapse">
  <li><a href="#listener-in-trustcall" id="toc-listener-in-trustcall" class="nav-link" data-scroll-target="#listener-in-trustcall">Listener in TrustCall</a></li>
  <li><a href="#implementation-details-2" id="toc-implementation-details-2" class="nav-link" data-scroll-target="#implementation-details-2">Implementation details</a></li>
  <li><a href="#managing-runs" id="toc-managing-runs" class="nav-link" data-scroll-target="#managing-runs">managing runs</a></li>
  <li><a href="#threads" id="toc-threads" class="nav-link" data-scroll-target="#threads">threads</a></li>
  <li><a href="#across-thread-memory" id="toc-across-thread-memory" class="nav-link" data-scroll-target="#across-thread-memory">across-thread memory</a></li>
  </ul></li>
  <li><a href="#double-texting" id="toc-double-texting" class="nav-link" data-scroll-target="#double-texting">Double-texting</a>
  <ul class="collapse">
  <li><a href="#reject" id="toc-reject" class="nav-link" data-scroll-target="#reject">Reject</a></li>
  <li><a href="#enqueue" id="toc-enqueue" class="nav-link" data-scroll-target="#enqueue">Enqueue</a></li>
  <li><a href="#interrupt" id="toc-interrupt" class="nav-link" data-scroll-target="#interrupt">Interrupt</a></li>
  <li><a href="#rollback" id="toc-rollback" class="nav-link" data-scroll-target="#rollback">Rollback</a></li>
  </ul></li>
  <li><a href="#assistants" id="toc-assistants" class="nav-link" data-scroll-target="#assistants">Assistants</a>
  <ul class="collapse">
  <li><a href="#creating-assistants" id="toc-creating-assistants" class="nav-link" data-scroll-target="#creating-assistants">Creating assistants</a></li>
  <li><a href="#updating-assistants" id="toc-updating-assistants" class="nav-link" data-scroll-target="#updating-assistants">Updating assistants</a></li>
  <li><a href="#managing-assistants" id="toc-managing-assistants" class="nav-link" data-scroll-target="#managing-assistants">Managing assistants</a></li>
  <li><a href="#using-assistants" id="toc-using-assistants" class="nav-link" data-scroll-target="#using-assistants">Using assistants</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">index</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="state-reducers" class="level1">
<h1>State Reducers</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-2/state-reducers.ipynb</p>
<section id="custom-reducers" class="level2">
<h2 class="anchored" data-anchor-id="custom-reducers">Custom Reducers</h2>
<p>def reduce_list(left: list | None, right: list | None) -&gt; list:</p>
<p>class CustomReducerState(TypedDict): foo: Annotated[list[int], reduce_list]</p>
</section>
<section id="re-writing" class="level2">
<h2 class="anchored" data-anchor-id="re-writing">Re-writing</h2>
<p>If we pass a message with the same ID as an existing one in our messages list, it will get overwritten!</p>
</section>
</section>
<section id="new-message-to-add" class="level1">
<h1>New message to add</h1>
<p>new_message = HumanMessage(content=“I’m looking for information on whales, specifically”, name=“Lance”, id=“2”)</p>
<section id="removal" class="level2">
<h2 class="anchored" data-anchor-id="removal">Removal</h2>
<p>We can remove messages by using RemoveMessage.</p>
<p>delete_messages = [RemoveMessage(id=m.id) for m in messages[:-2]] add_messages(messages , delete_messages)</p>
</section>
</section>
<section id="multiple-schemas" class="level1">
<h1>Multiple Schemas</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-2/multiple-schemas.ipynb</p>
<section id="private-state" class="level2">
<h2 class="anchored" data-anchor-id="private-state">Private State</h2>
<p>class OverallState(TypedDict): foo: int</p>
<p>class PrivateState(TypedDict): baz: int</p>
<p>def node_1(state: OverallState) -&gt; PrivateState: print(“—Node 1—”) return {“baz”: state[‘foo’] + 1}</p>
<p>def node_2(state: PrivateState) -&gt; OverallState: print(“—Node 2—”) return {“foo”: state[‘baz’] + 1}</p>
</section>
<section id="input-output-schema" class="level2">
<h2 class="anchored" data-anchor-id="input-output-schema">Input / Output Schema</h2>
<p>class InputState(TypedDict): question: str</p>
<p>class OutputState(TypedDict): answer: str</p>
<p>class OverallState(TypedDict): question: str answer: str notes: str</p>
<p>def thinking_node(state: InputState): return {“answer”: “bye”, “notes”: “… his is name is Lance”}</p>
<p>def answer_node(state: OverallState) -&gt; OutputState: return {“answer”: “bye Lance”}</p>
<p>graph = StateGraph(OverallState, input_schema=InputState, output_schema=OutputState) graph.add_node(“answer_node”, answer_node)</p>
</section>
</section>
<section id="trim-filter-messages" class="level1">
<h1>Trim / Filter Messages</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-2/trim-filter-messages.ipynb</p>
<section id="reducer" class="level2">
<h2 class="anchored" data-anchor-id="reducer">Reducer</h2>
<p>from langchain_core.messages import RemoveMessage</p>
<p>def filter_messages(state: MessagesState): # Delete all but the 2 most recent messages delete_messages = [RemoveMessage(id=m.id) for m in state[“messages”][:-2]] return {“messages”: delete_messages}</p>
<p>def chat_model_node(state: MessagesState):<br>
return {“messages”: [llm.invoke(state[“messages”])]}</p>
<p>builder = StateGraph(MessagesState) builder.add_node(“filter”, filter_messages) builder.add_node(“chat_model”, chat_model_node)</p>
</section>
<section id="filtering-messages" class="level2">
<h2 class="anchored" data-anchor-id="filtering-messages">Filtering messages</h2>
<p>def chat_model_node(state: MessagesState): return {“messages”: [llm.invoke(state[“messages”][-1:])]}</p>
</section>
<section id="trim-messages" class="level2">
<h2 class="anchored" data-anchor-id="trim-messages">Trim messages</h2>
<p>from langchain_core.messages import trim_messages</p>
<p>def chat_model_node(state: MessagesState): messages = trim_messages( state[“messages”], max_tokens=100, strategy=“last”, token_counter=ChatOpenAI(model=“gpt-4o”), allow_partial=False, ) return {“messages”: [llm.invoke(messages)]}</p>
</section>
</section>
<section id="chatbot-summarization" class="level1">
<h1>Chatbot Summarization</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-2/chatbot-summarization.ipynb</p>
<p>Building blocks:</p>
<ul>
<li><p>RemoveMessage =&gt; remove all but the last 2 messages when there is a summary.</p></li>
<li><p>State with new field summary</p>
<p>class State(MessagesState): summary: str</p></li>
<li><p>model node</p>
<ul>
<li>if summary exists, will append systemmessage asking to use it</li>
</ul></li>
<li><p>summarize_conversation node</p>
<ul>
<li>will ask to summarize conversation, using existing summary if exists (by appending humanmenssage with summary embedded, asking to use the summary so far) or conversation up to now otherwise</li>
<li>will output as new conversation (i.e, new state) the summary plus last 2 messages.
<ul>
<li>this is done by using summary field and using RemoveMessage to remove all but last 2 messages in messages field.</li>
</ul></li>
</ul></li>
<li><p>should_continue for add_conditional_edges</p>
<ul>
<li>will move to summarize_conversation if more than X messages in conversation so far, or to END if converstaion still short.</li>
</ul></li>
<li><p>memory:</p>
<ul>
<li>with config being configurable with thread_id, think about slack threads.</li>
</ul></li>
</ul>
</section>
<section id="chatbot-with-external-memory" class="level1">
<h1>Chatbot with External Memory</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-2/chatbot-external-memory.ipynb</p>
<section id="sqlite" class="level2">
<h2 class="anchored" data-anchor-id="sqlite">SQLite</h2>
<p>import sqlite3 db_path = “state_db/example.db” conn = sqlite3.connect(db_path, check_same_thread=False)</p>
<p>from langgraph.checkpoint.sqlite import SqliteSaver memory = SqliteSaver(conn)</p>
</section>
</section>
<section id="ux-and-human-in-the-loop" class="level1">
<h1>UX and Human-in-the-Loop</h1>
<ul>
<li>Use cases:
<ul>
<li>approval</li>
<li>correction / editing / human taking action</li>
</ul></li>
<li>State can be updated by human</li>
<li>Can be used for debugging</li>
<li>AI resume later</li>
</ul>
</section>
<section id="streaming-and-interruption" class="level1">
<h1>Streaming and Interruption</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-3/streaming-interruption.ipynb</p>
<section id="streaming-modes" class="level2">
<h2 class="anchored" data-anchor-id="streaming-modes">Streaming modes</h2>
<ul>
<li>values, updates =&gt; full state, only updated part</li>
<li>tokens</li>
</ul>
<p>state-wise:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {<span class="st">"configurable"</span>: {<span class="st">"thread_id"</span>: <span class="st">"1"</span>}}</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> chunk <span class="kw">in</span> graph.stream({<span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"hi! I'm Lance"</span>)]}, config, stream_mode<span class="op">=</span><span class="st">"updates"</span>):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(chunk)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>token-wise: - no stream_mode - async mode:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> event <span class="kw">in</span> graph.astream_events</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>we print: event[“metadata”] (includes node in “langraph_node” field), event[“event”] (type), event[“name”]</li>
<li>we could also print event[“data”]</li>
<li>we can select to print only the llm calls from the node of the graph that we’re interested in, in the example “conversation”.
<ul>
<li>we also indicate the event type, in our case “on_chat_model_stream” if we want to see llm responses</li>
</ul></li>
<li>This provides chunk outputs, which are the tokens. We can print them nicely as</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> event[<span class="st">"event"</span>]<span class="op">==</span><span class="st">"on.."</span> <span class="kw">and</span> event[<span class="st">"metadata"</span>][<span class="st">"langgraph_node"</span>]<span class="op">==</span><span class="st">"conversation"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> event[<span class="st">"data"</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (data[<span class="st">"chunk"</span>].content, end<span class="op">=</span><span class="st">"|"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="messages-mode" class="level3">
<h3 class="anchored" data-anchor-id="messages-mode">messages mode</h3>
<ul>
<li>assume <code>messages</code> field, which is list of messages.</li>
<li></li>
</ul>
</section>
</section>
<section id="langraph-studio" class="level2">
<h2 class="anchored" data-anchor-id="langraph-studio">Langraph studio</h2>
<ul>
<li><p>We can take the client handle and retrieve:</p>
<ul>
<li>graphs running: assistants</li>
</ul></li>
<li><p>Also create threads</p></li>
<li><p>Print data:</p></li>
</ul>
<p>this is the payload, and “messages” is the state</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">'messages'</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            <span class="er">'content'</span><span class="fu">:</span> <span class="er">'Multiply</span> <span class="dv">2</span> <span class="er">and</span> <span class="dv">3</span><span class="er">'</span><span class="fu">,</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            <span class="er">'additional_kwargs'</span><span class="fu">:</span> <span class="fu">{},</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            <span class="er">'response_metadata'</span><span class="fu">:</span> <span class="fu">{},</span> </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            <span class="er">'type'</span><span class="fu">:</span> <span class="er">'human'</span><span class="fu">,</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            <span class="er">'name'</span><span class="fu">:</span> <span class="er">None</span><span class="fu">,</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="er">'id'</span><span class="fu">:</span> <span class="er">'</span><span class="dv">9</span><span class="er">aaa247f</span><span class="dv">-1e6</span><span class="er">e</span><span class="dv">-4451</span><span class="er">-af25-ac678fe46d82'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="breakpoints" class="level1">
<h1>Breakpoints</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-3/breakpoints.ipynb</p>
<section id="breakpoints-with-langgraph-api" class="level2">
<h2 class="anchored" data-anchor-id="breakpoints-with-langgraph-api">Breakpoints with LangGraph API</h2>
<ul>
<li>We add <code>interrupt_before=[tools]</code> to the call <code>graph.compile(...)</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> builder.<span class="bu">compile</span>(interrupt_before<span class="op">=</span>[<span class="st">"tools"</span>], checkpointer<span class="op">=</span>memory)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><code>x_ray</code> to <code>get_graph</code> =&gt; visualizes the breakpoints</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Image(graph.get_graph(xray<span class="op">=</span><span class="va">True</span>).draw_mermaid_png())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>pass None when we invoke the graph =&gt; resume from previous checkpoint:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream(<span class="va">None</span>, thread, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="langgraph-studio" class="level3">
<h3 class="anchored" data-anchor-id="langgraph-studio">Langgraph studio</h3>
<p>Equivalent calls:</p>
<ul>
<li>First call for indicating interruption:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>thread <span class="op">=</span> client.threads.create() <span class="co"># Difference 1: instead of creating thread = {"configurable": {"thread_id": "1"}}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> chunk <span class="kw">in</span> client.runs.stream ( <span class="co"># Difference 2: `async for` instead of `for`</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    assistant_id<span class="op">=</span><span class="st">"agent"</span>, <span class="co"># Difference 3, we have several graphs and need to indicate which one</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>initial_input, <span class="co"># if placed as first argument, no need to use keyword input</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    stream_mode<span class="op">=</span><span class="st">"values"</span>, <span class="co"># same</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    interrupt_before<span class="op">=</span>[<span class="st">"tools"</span>], <span class="co"># Difference 4: breakpoint indicating in stream command </span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># instead of compile (since the graph has already been compiled)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Second call for resuming:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> chunk <span class="kw">in</span> client.runs.stream ( </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    assistant_id<span class="op">=</span><span class="st">"agent"</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="va">None</span>, <span class="co"># None goes here</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    stream_mode<span class="op">=</span><span class="st">"values"</span>, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    interrupt_before<span class="op">=</span>[<span class="st">"tools"</span>],</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
</section>
<section id="editing-state-and-human-feedback" class="level1">
<h1>Editing state and human feedback</h1>
<p>https://github.com/langchain-ai/langchain-academy/blob/main/module-3/edit-state-human-feedback.ipynb</p>
<section id="update-state-message" class="level2">
<h2 class="anchored" data-anchor-id="update-state-message">Update state / message</h2>
<ul>
<li>First option: append message to previous list (add_messages reducer)</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>graph.update_state (</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    thread,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"my new message"</span>)]}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Second option: replace the message. We need to supply the message id</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> graph.get_state(thread)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>or</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> <span class="cf">await</span> client.threads.get_state(thread[<span class="st">"thread_id"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>and then:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>new_message <span class="op">=</span> state[<span class="st">"values"</span>][<span class="st">"messages"</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>new_message[<span class="st">"content"</span>] <span class="op">=</span> <span class="st">"my new message"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>new_state <span class="op">=</span> {<span class="st">"messages"</span>: new_message}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>and:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>graph.update_state(thread, new_state)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>or:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client.threads.update_state(thread[<span class="st">"thread_id"</span>], new_state)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="langgraph-studio-1" class="level2">
<h2 class="anchored" data-anchor-id="langgraph-studio-1">Langgraph studio</h2>
<ul>
<li>We can add interruptions through the UI, besides the node icon in the graph</li>
<li>We can edit the messages in the chat. Afterwards, we need to <strong>fork</strong> the thread by pressing the button “fork” below the message.</li>
<li>After editing</li>
</ul>
</section>
<section id="awaiting-user-input" class="level2">
<h2 class="anchored" data-anchor-id="awaiting-user-input">Awaiting user input</h2>
<ul>
<li>add placeholder (no-op) function for collecting human feedback:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> human_feedback (state: MessageState):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>builder.add_node (<span class="st">"human_feedback"</span>, human_feedback)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>add interruption before human feedback node.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>graph <span class="op">=</span> builder.<span class="bu">compile</span> (..., interrupt_before<span class="op">=</span>[<span class="st">"human_feedback"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>when updating state, add <code>as_node="human_feedback"</code> to imitate the case that the message was updated in that node.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>new_message <span class="op">=</span> <span class="bu">input</span> (<span class="st">"new message: "</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>graph.update_state (thread, new_message, as_node<span class="op">=</span><span class="st">"human_feedback"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="dynamic-breakpoints" class="level1">
<h1>Dynamic breakpoints</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-3/dynamic-breakpoints.ipynb">notebook</a></p>
<section id="conditional" class="level2">
<h2 class="anchored" data-anchor-id="conditional">Conditional</h2>
<ul>
<li>Benefits:
<ul>
<li>triggered only on certain conditions.</li>
<li>allows to communicate reason.</li>
</ul></li>
<li>In node, if condition occurs, a <code>NodeInterrupt</code> error is raised:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langgraph.errors <span class="im">import</span> NodeInterrupt</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> node (state: MyStateClass):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> condition:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> NodeInterrupt (<span class="ss">f"State </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> meets condition"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can see breakpoint information as:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> graph.get_state (thread_config)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (state.tasks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="time-travel" class="level1">
<h1>Time Travel</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-3/time-travel.ipynb">notebook</a></p>
<section id="replay" class="level2">
<h2 class="anchored" data-anchor-id="replay">Replay</h2>
<ul>
<li>Get history with:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>state_history <span class="op">=</span> [s <span class="cf">for</span> s <span class="kw">in</span> graph.get_state_history(thread)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Replay using:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream (<span class="bu">input</span><span class="op">=</span><span class="va">None</span>, state_history[idx].config, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    ... </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="time_travel.png" class="img-fluid figure-img"></p>
<figcaption>checkpoint_history.jpg</figcaption>
</figure>
</div>
</section>
<section id="fork" class="level2">
<h2 class="anchored" data-anchor-id="fork">Fork</h2>
<ul>
<li>Used to replay with different state values.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>new_state <span class="op">=</span> ...</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>fork_config <span class="op">=</span> graph.update_state (state_history[idx].config, new_state)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream (<span class="va">None</span>, fork_config, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In case we use <code>MessageState</code>, we’ll want to overwrite the previous message with a new one, by passing the message ID:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>new_state <span class="op">=</span> {<span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"new message"</span>, <span class="bu">id</span><span class="op">=</span>state_history[idx].values[<span class="st">"messages"</span>][<span class="dv">0</span>].<span class="bu">id</span>)]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="using-langgraph-studio" class="level3">
<h3 class="anchored" data-anchor-id="using-langgraph-studio">Using Langgraph studio</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>state_history <span class="op">=</span> client.threads.get_history (thread[<span class="st">"thread_id"</span>])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>forked_input <span class="op">=</span> {<span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"my new message"</span>, <span class="bu">id</span><span class="op">=</span>state_histor[idx][<span class="st">"values"</span>][<span class="st">"messages"</span>][<span class="dv">0</span>][<span class="st">"id"</span>]]}</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client.threads.update_state (</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    forked_input,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    checkpoint_id<span class="op">=</span>state_history[idx][<span class="st">"checkpoint_id"</span>]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> chunk <span class="kw">in</span> client.runs.stream (</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    assistant_id<span class="op">=</span><span class="st">"agent"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span><span class="va">None</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    stream_updates<span class="op">=</span><span class="st">"updates"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    checkpoint_id<span class="op">=</span>state_history[idx][<span class="st">"checkpoint_id"</span>]</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes">Notes</h3>
<p>When we udpate the state we are actually adding a new checkpoint to the history, so it becomes larger and larger.</p>
</section>
</section>
</section>
<section id="building-your-assistant" class="level1">
<h1>Building your assistant</h1>
</section>
<section id="parallelization" class="level1">
<h1>Parallelization</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-4/parallelization.ipynb">notebook</a></p>
<section id="control-execution-order-of-parallel-nodes" class="level2">
<h2 class="anchored" data-anchor-id="control-execution-order-of-parallel-nodes">Control execution order of parallel nodes</h2>
<p>Several ways:</p>
<ol type="1">
<li>Reducer `</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sorted_reducer (left, right):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(left, <span class="bu">list</span>):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        left <span class="op">=</span> [left]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(right, <span class="bu">list</span>):</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        right <span class="op">=</span> [right]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span> (left<span class="op">+</span>right)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="2" type="1">
<li>Sink node:</li>
</ol>
<ul>
<li>Write updates to different fields of the state</li>
<li>Sink node joins the updates in whichever way considers appropriate</li>
<li>Then it deletes the temporary fields from state.</li>
</ul>
</section>
<section id="realistic-example" class="level2">
<h2 class="anchored" data-anchor-id="realistic-example">Realistic example</h2>
<ul>
<li>Query web and wikipedia to get context, and have LLM use it to respond query.</li>
<li>Web search: tavily, with API key. Import from <code>langchain_tavily</code></li>
<li>Wikipedia search: WikipediaLoader from <code>langchain_community.document_loaders</code></li>
</ul>
</section>
</section>
<section id="sub-graphs" class="level1">
<h1>Sub-graphs</h1>
<ul>
<li>Sub-graphs can be used for different agents in a multi-agent graph.</li>
<li>A sub-graph is a node where we pass a compiled graph as “function”.</li>
<li>Each sub-graph can have a different input and output state schema.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fa_builder <span class="op">=</span> StateGraph (state_schema<span class="op">=</span>FailureAnalysisState, output_schema<span class="op">=</span>FailureAnalysisOutputState)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>qs_builder <span class="op">=</span> StateGraph(QuestionSummarizationState,output_schema<span class="op">=</span>QuestionSummarizationOutputState)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>entry_builder.add_node (<span class="st">"failure_analysis"</span>, fa_builder.<span class="bu">compile</span>())</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>entry_builder.add_node (<span class="st">"qs_analysis"</span>, qs_builder.<span class="bu">compile</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The state introduce to failure_analysis and qs_analysis sub-graphs can have additional fields that are not present in the schema of those sub-graphs:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EntryGraphState(TypedDict):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    raw_logs: List[Log]             <span class="co"># not present in sub-graphs schemas: internal field</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    cleaned_logs: List[Log]         <span class="co"># overlap: input used by sub-graphs</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    fa_summary: <span class="bu">str</span>                 <span class="co"># overlap with fa schema: output provided by fa subgraph</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    report: <span class="bu">str</span>                     <span class="co"># overlap with qs schema: output provided by qs subgraph</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    processed_logs:  Annotated[List[<span class="bu">int</span>], add] <span class="co"># overlap with both schemas: output provided by both sub-graphs (has reducer)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FailureAnalysisState(TypedDict):</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    cleaned_logs: List[Log]         <span class="co"># overlap</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    failures: List[Log]             <span class="co"># new: internal field</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    fa_summary: <span class="bu">str</span>                 <span class="co"># overlap</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    processed_logs: List[<span class="bu">str</span>]       <span class="co"># overlap</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QuestionSummarizationState(TypedDict):</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    cleaned_logs: List[Log]         <span class="co"># overlap </span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    qs_summary: <span class="bu">str</span>                 <span class="co"># new: internal field</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    report: <span class="bu">str</span>                     <span class="co"># overlap</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    processed_logs: List[<span class="bu">str</span>]       <span class="co"># overlap</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>A node can return a state with only some of the fields of its output state schema.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> send_to_slack(state):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    qs_summary <span class="op">=</span> state[<span class="st">"qs_summary"</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add fxn: report = report_generation(qs_summary)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    report <span class="op">=</span> <span class="st">"foo bar baz"</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"report"</span>: report}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="notes-1" class="level3">
<h3 class="anchored" data-anchor-id="notes-1">Notes</h3>
<p>If the sub-graphs don’t use a different output schema, then we need to indicate reducers for fields such as <code>cleaned_logs</code> that, although unmodified, are used by both sub-graphs.</p>
</section>
</section>
<section id="map-reduce" class="level1">
<h1>Map-Reduce</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-4/map-reduce.ipynb">notebook</a></p>
<section id="using-send-and-conditional-edges" class="level2">
<h2 class="anchored" data-anchor-id="using-send-and-conditional-edges">Using send and conditional edges</h2>
<ul>
<li>To go from a single node <code>before_map</code> to copies of a node that run in parallel (<code>map</code> step), define a function that uses <code>Send</code> to the node:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_map (state):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [Send(<span class="st">"my_map_node"</span>, {<span class="st">"my_node_input"</span>: s}) <span class="cf">for</span> s <span class="kw">in</span> state[<span class="st">"my_list_of_inputs"</span>]] </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then add a conditional edge from the single node <code>before_map</code> to the parallel list of clones of <code>my_map</code> node:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>builder.add_conditional_edges (<span class="st">"before_map"</span>, <span class="st">"my_map"</span>, [<span class="st">"my_map_node"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>And add a normal edge that goes from <code>my_map_node</code> to <code>my_reducer_node</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>builder.add_edge (<span class="st">"my_map_node"</span>, <span class="st">"my_reducer_node"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><code>my_map_node</code> needs to output to a field which has a reducer function in it:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyOverallState ():</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    my_output_field: Annotated[my_output_type, my_reducer_function]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_map_node (state: MyOverallState):</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"my_output_field"</span>: my_return_value} </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="notes-about-example-used-in-tutorial" class="level2">
<h2 class="anchored" data-anchor-id="notes-about-example-used-in-tutorial">Notes about example used in tutorial</h2>
<ul>
<li>We use structured output for the LLM:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ChatOpenAI (...)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_node ():</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> model.with_structured_output(MyStateClass).invoke(my_prompt)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"my_output_field"</span>: response.my_field}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="implementation-details" class="level3">
<h3 class="anchored" data-anchor-id="implementation-details">Implementation details</h3>
<p>We can get access to the model response content as <code>response.content</code></p>
</section>
</section>
</section>
<section id="long-term-memory" class="level1">
<h1>Long term memory</h1>
</section>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p><a href="https://files.cdn.thinkific.com/file_uploads/967498/attachments/dc4/f52/87a/LangChain_Academy_-_Introduction_to_LangGraph_-_Long-Term_Memory.pdf">slides</a> <a href="https://docs.langchain.com/oss/python/langgraph/memory">tutorial</a></p>
<section id="short-vs-long-term-memory" class="level2">
<h2 class="anchored" data-anchor-id="short-vs-long-term-memory">Short vs Long term memory</h2>
<ul>
<li>Short term memory:
<ul>
<li>in session, single thread</li>
<li>with checkpointer</li>
<li>past messages can be summarized or filtered (e.g., truncate them)</li>
</ul></li>
<li>Long term memory:
<ul>
<li>across sessions, across threads</li>
<li>with store</li>
</ul></li>
</ul>
</section>
<section id="long-term-memory-1" class="level2">
<h2 class="anchored" data-anchor-id="long-term-memory-1">Long term memory:</h2>
<section id="type-of-memory" class="level3">
<h3 class="anchored" data-anchor-id="type-of-memory">Type of memory:</h3>
<section id="semantic" class="level4">
<h4 class="anchored" data-anchor-id="semantic">1 Semantic</h4>
<ul>
<li>facts, user data</li>
<li>structure: profile (dict with fields) or list of items (e.g., locations), updated after each session</li>
<li>Pros:
<ul>
<li>Single document (profile): easily retrieved</li>
<li>List: narrow scope, easy to add</li>
</ul></li>
<li>Cons:
<ul>
<li>Single document: difficult to maintain when it grows</li>
<li>List: costly to retrieve as it grows.</li>
</ul></li>
</ul>
</section>
<section id="episodic" class="level4">
<h4 class="anchored" data-anchor-id="episodic">2 Episodic</h4>
<ul>
<li>memories: agent actions</li>
</ul>
</section>
<section id="procedural" class="level4">
<h4 class="anchored" data-anchor-id="procedural">3 Procedural</h4>
<ul>
<li>prompts</li>
<li>Using AI to generate prompts based on human feedback, tests and evaluation scores (LangSmith)</li>
</ul>
<p><a href="https://www.youtube.com/watch?v=Vn8A3BxfplE">video</a> <a href="https://github.com/langchain-ai/langsmith-cookbook/blob/main/optimization/assisted-prompt-bootstrapping/elvis-bot.ipynb">notebook</a></p>
</section>
</section>
<section id="updates" class="level3">
<h3 class="anchored" data-anchor-id="updates">Updates</h3>
<section id="hot-path" class="level4">
<h4 class="anchored" data-anchor-id="hot-path">1 Hot path</h4>
<p>Pro: Real-time and transparent Con: delays / bad UX <a href="https://github.com/langchain-ai/memory-agent">github code</a></p>
</section>
<section id="background" class="level4">
<h4 class="anchored" data-anchor-id="background">2 Background</h4>
<p>Pro: no delays / good UX Con: Frequency of writing to be tuned <a href="https://github.com/langchain-ai/memory-template">github code</a></p>
</section>
</section>
</section>
</section>
<section id="langgraph-store" class="level1">
<h1>LangGraph Store</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-5/memory_store.ipynb">notebook</a></p>
<section id="implementation-details-1" class="level2">
<h2 class="anchored" data-anchor-id="implementation-details-1">Implementation details</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langgraph.store.memory <span class="im">import</span> InMemoryStore</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><strong>Memory saved</strong> using:
<ul>
<li>namespace: tuple, like directory</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>namespace <span class="op">=</span> (user_id, <span class="st">"memories"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>key: string, like filename</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>key <span class="op">=</span> <span class="st">"user_memory"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>value: like content of file:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>value <span class="op">=</span> {<span class="st">"food_preference"</span> : <span class="st">"I like pizza"</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li>Write: <strong>put</strong></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>    store.put (namespace, key, value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Read: <strong>get</strong></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>    memory <span class="op">=</span> store.get (namespace, key)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><strong>Retrieve all</strong>:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>    memories <span class="op">=</span> store.search (namespace)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><strong>config passed</strong>:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"configurable"</span>: {<span class="st">"thread_id"</span>: thread_id, <span class="st">"my_key_info"</span>: my_key_info}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li><strong>Important:</strong> The store needs to be passed to the node so that it can explicitly read values from the history and act on them, e.g., summarizing the memories or considering them in some specific manner:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_node_function (state: MyStateClass, config: RunnableConfig, store: BaseStore):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    user_id <span class="op">=</span> config[<span class="st">"configurable"</span>][<span class="st">"user_id"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>compiling with both short-term and long-term memory:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>builder.<span class="bu">compile</span> (</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    checkpointer<span class="op">=</span>my_checkpointer, <span class="co"># short_term_memory</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    store<span class="op">=</span>my_store, <span class="co"># long_term_memory</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {<span class="st">"configurable"</span>: {<span class="st">"thread_id"</span>: <span class="st">"1"</span>, <span class="st">"user_id"</span>: <span class="st">"1"</span>}}</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream (my_messages, config, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># we have across-session memory, so we can pass another thread_id:</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {<span class="st">"configurable"</span>: {<span class="st">"thread_id"</span>: <span class="st">"2"</span>, <span class="st">"user_id"</span>: <span class="st">"1"</span>}}</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream (my_messages, config, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="memory-schema-profile" class="level1">
<h1>Memory schema + profile</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-5/memoryschema_profile.ipynb">notebook</a></p>
<section id="model-with-structured-output" class="level2">
<h2 class="anchored" data-anchor-id="model-with-structured-output">Model with structured output</h2>
<ul>
<li>Use <code>with_structured_output</code> method to adhere to specific profile fields</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>new_memory <span class="op">=</span> model.with_structured_output (MyProfileSchema)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>new_memory <span class="op">=</span> my_format.<span class="bu">format</span>(new_memory)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="trustcall" class="level2">
<h2 class="anchored" data-anchor-id="trustcall">TrustCall</h2>
<ul>
<li>Adhere to more complex schemas (e.g., based on pydantic and multiple classes)</li>
<li>Update complex schemas without having to regenerate the whole schema and overwrite (i.e., more efficiently)</li>
</ul>
<section id="call" class="level3">
<h3 class="anchored" data-anchor-id="call">Call</h3>
<p>We pass:</p>
<ul>
<li>A model</li>
<li>A schema as a tool: <code>tools = [MySchema]</code></li>
<li>A tool choice name for enforcing output to respect this schema: <code>tool_choise = "MySchema"</code></li>
</ul>
<p>We retrieve:</p>
<ul>
<li>AI messages:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>result[<span class="st">"messages"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Structured output:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>result[<span class="st">"responses"</span>] <span class="co"># list of MySchema objects </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>result[<span class="st">"responses"</span>][<span class="dv">0</span>].model_dump()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Metadata: result[“response_metadata”]</li>
</ul>
<p>Example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> trustcall <span class="im">import</span> create_extractor</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, ValidationError</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MySchema (BaseModel):</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> Field (description<span class="op">=</span><span class="st">"user name"</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    interests: List[<span class="bu">str</span>] <span class="op">=</span> Field (description<span class="op">=</span><span class="st">"list of user interests"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>conversation <span class="op">=</span> [</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    HumanMessage (content<span class="op">=</span><span class="st">"Hi I'm Jaume"</span>),</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    AIMessage (content<span class="op">=</span><span class="st">"Hi Jaume, how can I assist you?"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    HumanMessage (content<span class="op">=</span><span class="st">"I like biking for cardio and sightseeing"</span>)</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>extractor <span class="op">=</span> create_extractor (</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    tools<span class="op">=</span>[MySchema],</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    tool_choice<span class="op">=</span><span class="st">"MySchema"</span>,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>system_message<span class="op">=</span>SystemMessage(content<span class="op">=</span><span class="st">"Extract user details from this conversation"</span>)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>extractor.invoke ({<span class="st">"messages"</span>: [system_message] <span class="op">+</span> conversation})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="update" class="level2">
<h2 class="anchored" data-anchor-id="update">Update</h2>
<ul>
<li>Produce a json patch</li>
<li>We pass the serialized object using</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"existing"</span>: {<span class="st">"MySchema"</span>: result[<span class="st">"response"</span>][<span class="dv">0</span>].model_dump()}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note that we indicate the name of the class to respect, “MySchema”</p>
<p>Full call:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>creator.invoke (</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"messages"</span>: [system_message] <span class="op">+</span> updated_conversation}, </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"existing"</span>: {<span class="st">"MySchema"</span>: result[<span class="st">"response"</span>][<span class="dv">0</span>].model_dump()}}</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can also put “messages” and “existing” into a single dictionary:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"messages"</span>: [...], <span class="st">"existing"</span>: existing_memory_as_dict}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>When writing into our store, we need to deserialize the object:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>my_store.put (namespace, key, result[<span class="st">"responses"</span>][<span class="dv">0</span>].model_dump())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="memory-schema-collection" class="level1">
<h1>Memory Schema + Collection</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-5/memoryschema_collection.ipynb">notebook</a></p>
<section id="model-with-structured-output-1" class="level2">
<h2 class="anchored" data-anchor-id="model-with-structured-output-1">model with structured output</h2>
<ul>
<li>Define using BaseModel</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyMemory (BaseModel):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    memory: <span class="bu">str</span> <span class="op">=</span> Field (description<span class="op">=</span><span class="st">"One of the memories"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyCollection (BaseModel):</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    my_collection: List[MyMemory] <span class="op">=</span> Field (description<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>model_with_structure <span class="op">=</span> mode.with_structured_output (MyCollection)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> model_with_structure.invoke (...)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Save to store using put with one key per item in the collection:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> item <span class="kw">in</span> result.my_collection:</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4 ())</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    my_store.put (namespace, key, item.model_dump())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="trustcall-1" class="level2">
<h2 class="anchored" data-anchor-id="trustcall-1">TrustCall</h2>
<ul>
<li>use single element class (<code>MyMemory</code> in previous example)</li>
<li>pass <code>enable_inserts=True</code> when building the extractor object</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>extractor <span class="op">=</span> create_extractor (</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    tools<span class="op">=</span>[MyMemory],</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    tool_choice<span class="op">=</span>[<span class="st">"MyMemory"</span>],</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    enable_inserts<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>system_msg <span class="op">=</span> <span class="st">"""Update existing memories and create new ones based on the following conversation:"""</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>extractor.invoke({<span class="st">"messages"</span>: [SystemMessage(content<span class="op">=</span>system_msg)]<span class="op">+</span>updated_conversation, <span class="st">"existing"</span>: existing_memories})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="graph-trustcall" class="level2">
<h2 class="anchored" data-anchor-id="graph-trustcall">Graph + TrustCall</h2>
<ul>
<li><p>TrustCall instruction prompt: “… use parallel tool calling to handle updates and insertions simulatenously:”</p></li>
<li><p>when using memories to adapt the assistant response: since it is a list, we format the {memory} section of the prompt using the list of memories so far retrieved with search:</p></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>memories <span class="op">=</span> my_store.search(namespace)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>formatted_memories <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([mem.value[<span class="st">"content"</span>] <span class="cf">for</span> mem <span class="kw">in</span> memories])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>existing_memories construction:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>namespace<span class="op">=</span>(<span class="st">"memory"</span>, user_id)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>existing_items <span class="op">=</span> my_store.search(namespace)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>tool_name<span class="op">=</span><span class="st">"Memory"</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>existing_memories <span class="op">=</span> ([(existing_item.key, tool_name, existing_item.value) <span class="cf">for</span> existing_item <span class="kw">in</span> existing_items] <span class="cf">if</span> existing_items <span class="cf">else</span> <span class="va">None</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>using <code>merge_message_runs</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>system_msg <span class="op">=</span> SystemMessage(content<span class="op">=</span><span class="st">"my prompt message"</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>updated_messages <span class="op">=</span> <span class="bu">list</span>(merge_message_runs(messages<span class="op">=</span>[system_msg]<span class="op">+</span>state[<span class="st">"messages"</span>]))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>result<span class="op">=</span>creator.invoke ({<span class="st">"messages"</span>: updated_messages, <span class="st">"existing"</span>: existing_memories})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>store update</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resp, rmeta <span class="kw">in</span> <span class="bu">zip</span>(result[<span class="st">"responses"</span>], result[<span class="st">"response_metadata"</span>]):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    my_store.put (</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>        namespace, </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        rmeta.get(<span class="st">"json_doc_id"</span>, uuid.uuid4()), <span class="co"># if memory is new, it is appended (add_messages reducer) since it has a new ID. If it is an existing one, it is overwritten, since we provide its previous json_doc_id as ID</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        resp.model_dump(mode<span class="op">=</span><span class="st">"json"</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="memory-agent" class="level1">
<h1>Memory agent</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-5/memory_agent.ipynb">notebook</a></p>
<section id="listener-in-trustcall" class="level2">
<h2 class="anchored" data-anchor-id="listener-in-trustcall">Listener in TrustCall</h2>
<p>Log tool calls done by TrustCall</p>
<p>Surface things like: - actions to solve schema validation errors, and - updates done to previous memories</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Spy:</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>spy <span class="op">=</span> Spy()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>extractor <span class="op">=</span> create_extractor(...)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>extractor_with_listener <span class="op">=</span> extractor.with_listeners(on_end<span class="op">=</span>spy)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Spy:</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span> (<span class="va">self</span>):</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.called_tools <span class="op">=</span> []</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span> (<span class="va">self</span>, run):</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        q <span class="op">=</span> [run]</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> q:</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> q.pop()</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> r.child_runs:</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>                q.extend(r.child_runs)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> r.run_type<span class="op">==</span><span class="st">"chat_model"</span>:</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.called_tools.append(r.outputs[<span class="st">"generations"</span>][<span class="dv">0</span>][<span class="dv">0</span>][<span class="st">"messages"</span>][<span class="st">"kwargs"</span>][<span class="st">"tool_calls"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="implementation-details-2" class="level2">
<h2 class="anchored" data-anchor-id="implementation-details-2">Implementation details</h2>
<p>When calling a tool node it is very important that the node responds back notifying that the call was made:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tool_node (...):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    tool_calls <span class="op">=</span> state[<span class="st">"messages"</span>][<span class="op">-</span><span class="dv">1</span>].tool_calls</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"messages"</span>: [{<span class="st">"role"</span>: <span class="st">"tool"</span>, <span class="st">"content"</span>: <span class="st">"my tool response"</span>, <span class="st">"tool_call_id"</span>: tool_calls[<span class="dv">0</span>][<span class="st">"id"</span>]}]}</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Deployment</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Deployment concepts</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>[notebook](https:<span class="op">//</span>files.cdn.thinkific.com<span class="op">/</span>file_uploads<span class="op">/</span><span class="dv">967498</span><span class="op">/</span>attachments<span class="op">/</span><span class="dv">5</span><span class="er">d8</span><span class="op">/</span><span class="dv">68</span><span class="er">e</span><span class="op">/</span><span class="dv">5</span><span class="er">fd</span><span class="op">/</span>LangChain_Academy_<span class="op">-</span>_Introduction_to_LangGraph_<span class="op">-</span>_Deployment.pdf)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co"># creating</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>[notebook](https:<span class="op">//</span>github.com<span class="op">/</span>langchain<span class="op">-</span>ai<span class="op">/</span>langchain<span class="op">-</span>academy<span class="op">/</span>blob<span class="op">/</span>main<span class="op">/</span>module<span class="op">-</span><span class="dv">6</span><span class="op">/</span>creating.ipynb)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> langgraph cli, docker <span class="kw">and</span> docker compose</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="co"># connecting</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="co">## client / remote graph</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>```python</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langgraph_sdk <span class="im">import</span> get_client</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="co"># langgraph-api:</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         image: "lg_image"</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         ports:</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a><span class="co">#             - "8123:8000"</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"http://localhost:8123"</span> <span class="co"># </span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> get_client (url<span class="op">=</span>url)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a><span class="co"># or ...</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>remote_graph <span class="op">=</span> RemoteGraph (graph_name, url<span class="op">=</span>url)</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a><span class="co"># (how to use remote_graph?)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="managing-runs" class="level2">
<h2 class="anchored" data-anchor-id="managing-runs">managing runs</h2>
<ul>
<li>list: <code>client.runs.list(thread["thread_id"])</code></li>
<li>create thread: <code>client.threads.create()</code></li>
<li>create run: <code>python     client.runs.create(thread["thread_id"], graph_name, input=input_message, config=config)</code>
<ul>
<li>Note: <code>config</code> here only contains the <code>user_id</code>, not the <code>thread_id</code>, since that piece is passed in the first argument.</li>
</ul></li>
<li>get run status: <code>client.runs.get(...)</code></li>
<li>block until complete (join): <code>client.runs.join(...)</code></li>
<li>stream (e.g., tokens): <code>client.runs.stream(...)</code>: same as create run, but adding parameter <code>stream_mode="messages-tuple"</code></li>
</ul>
</section>
<section id="threads" class="level2">
<h2 class="anchored" data-anchor-id="threads">threads</h2>
<ul>
<li>For working with multi-turn interactions, with multiple graphs executions for a given thread.</li>
<li>The server stores the checkpoints of the thread in Postgres.</li>
<li>We can:
<ul>
<li>get state checkpoints saved:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>thread_state <span class="op">=</span> <span class="cf">await</span> client.threads.get_state(thread[<span class="st">"thread_id"</span>])</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> convert_to_messages (thread_state[<span class="st">"values"</span>][<span class="st">"messages"</span>]):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    m.pretty_print()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>copy (fork) thread: <code>client.threads.copy(thread["thread_id"])</code></li>
<li>do human-in-the-loop:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> <span class="cf">await</span> client.threads.get_history(thread[<span class="st">"thread_id"</span>])</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>to_fork <span class="op">=</span> states[<span class="op">-</span><span class="dv">2</span>]</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># to_fork["values"], to_fork["next"]</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>message_id <span class="op">=</span> to_fork[<span class="st">"values"</span>][<span class="st">"messages"</span>][<span class="dv">0</span>][<span class="st">"id"</span>]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>checkpoint_id <span class="op">=</span> to_fork[<span class="st">"checkpoint_id"</span>]</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>forked_input <span class="op">=</span> {</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"my new message"</span>, <span class="bu">id</span><span class="op">=</span>message_id)] <span class="co"># overwrite previuos message by supplying ID</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>forked_config <span class="op">=</span> <span class="cf">await</span>.client.threads.update_state(</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    forked_input,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    checkpoint_id<span class="op">=</span>checkpoint_id</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>stream using updated input from new checkpoint
<ul>
<li>same call as last stream but with:
<ul>
<li>input=None, so that it resumes</li>
<li>adding <code>checkpoint_id=checkpoint_id</code></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="across-thread-memory" class="level2">
<h2 class="anchored" data-anchor-id="across-thread-memory">across-thread memory</h2>
<p>The memory store is stored in Postgres</p>
<p>We can:</p>
<ul>
<li>search items by namespace: <code>client.store.search(namespace)</code> where namspace is a tuple</li>
<li>put new items: <code>client.store.put_item (namespace, key=key, value=value)</code></li>
<li>delete items: <code>client.store.delete_item(namespace, key=key)</code></li>
</ul>
</section>
</section>
<section id="double-texting" class="level1">
<h1>Double-texting</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-6/double-texting.ipynb">notebook</a></p>
<section id="reject" class="level2">
<h2 class="anchored" data-anchor-id="reject">Reject</h2>
<ul>
<li>runs.create with input_1</li>
<li>try:
<ul>
<li>runs.create with input_2</li>
</ul></li>
<li>except httpx.HTTPStatusError as e: …</li>
</ul>
</section>
<section id="enqueue" class="level2">
<h2 class="anchored" data-anchor-id="enqueue">Enqueue</h2>
<ul>
<li>To new runs we add the argument <code>multitask_strategy="enqueue"</code></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>second_run <span class="op">=</span> <span class="cf">await</span> client.runs.create(..., multitask_strategy<span class="op">=</span><span class="st">"enqueue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>We await for the last run: <code>await client.runs.join(thread["thread_id"], second_run["run_id"])</code></li>
</ul>
</section>
<section id="interrupt" class="level2">
<h2 class="anchored" data-anchor-id="interrupt">Interrupt</h2>
<ul>
<li>The previous message will be interrupted and the new one take over.</li>
<li>How: as before, but we pass the argument <code>multitask_strategy="interrupt"</code>. Again, we await for the last run to complete.</li>
<li>The final status is “interrupted”.</li>
</ul>
</section>
<section id="rollback" class="level2">
<h2 class="anchored" data-anchor-id="rollback">Rollback</h2>
<ul>
<li>Instead of keeping the interrupted messages, a new run is created, the old one is deleted, and the new run takes only the new message.</li>
<li>How, as before, but we pass the argument <code>multitask_strategy="rollback"</code>.</li>
</ul>
</section>
</section>
<section id="assistants" class="level1">
<h1>Assistants</h1>
<p><a href="https://github.com/langchain-ai/langchain-academy/blob/main/module-6/assistant.ipynb">notebook</a></p>
<section id="creating-assistants" class="level2">
<h2 class="anchored" data-anchor-id="creating-assistants">Creating assistants</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>personal_assistant <span class="op">=</span> <span class="cf">await</span> client.assistants.create(graph_name, config<span class="op">=</span>{<span class="st">"configurable"</span>: {<span class="st">"todo_category"</span>: <span class="st">"personal"</span>}})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="updating-assistants" class="level2">
<h2 class="anchored" data-anchor-id="updating-assistants">Updating assistants</h2>
<ul>
<li>When updading an assistant, we are creating a new version of it.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>configurations <span class="op">=</span> {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"todo_category"</span>: <span class="st">"personal"</span>,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"user_id"</span>: <span class="st">"lance"</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"task_maistro_role"</span>: new_prompt,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>personal_assistant <span class="op">=</span> <span class="cf">await</span> client.assistants.update(</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    personal_assistant[<span class="st">"assistant_id"</span>],</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    config<span class="op">=</span>{<span class="st">"configurable"</span>: configurations},</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Notes:
<ul>
<li>The fields in the configurations dict coincide with the attributes of the <code>Configurations</code> class defined in deployment/configuration.py</li>
<li>Inside the llm node of the graph, in the <code>task_maistro.py</code> file, we have an argument of type <code>RunnableConfig</code>, which gives us a dictionary. This dictionary is transformed into a Configurations object using the classmethod <code>from_runnable_config</code>:</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> task_mAIstro (state: MessagesState, config: RunnableConfig, store: BaseStore):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    configurable <span class="op">=</span> configuration.Configuration.from_runnable_config(config)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># configurable.todo_category, configurable.user_id, configurable.task_maistro_role</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="managing-assistants" class="level2">
<h2 class="anchored" data-anchor-id="managing-assistants">Managing assistants</h2>
<ul>
<li>List assistants:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>assistants <span class="op">=</span> <span class="cf">await</span> client.assistants.search()</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> assistant <span class="kw">in</span> assistants:</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> ({</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"assistant_id"</span>: assistant[<span class="st">"assistant_id"</span>],</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"version"</span>: assistant[<span class="st">"version"</span>],</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"config"</span>: assistant[<span class="st">"config"</span>], </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="co"># config includes category, user_id, and role, as supplied in configurations dict above</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Delete assistant:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> client.assistants.delete(assistant[<span class="st">"assistant_id"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="using-assistants" class="level2">
<h2 class="anchored" data-anchor-id="using-assistants">Using assistants</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>thread <span class="op">=</span> <span class="cf">await</span> client.threads.create()</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="cf">for</span> chunk <span class="kw">in</span> client.runs.stream(</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    thread[<span class="st">"thread_id"</span>],</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    assistant_id,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>{<span class="st">"messages"</span>: [HumanMessage(content<span class="op">=</span><span class="st">"my message"</span>)]},</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    stream_mode<span class="op">=</span><span class="st">"values"</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> chunk.event <span class="op">==</span> <span class="st">"values"</span>:</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> chunk.data</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        convert_to_messages(state[<span class="st">"messages"</span>])[<span class="op">-</span><span class="dv">1</span>].pretty_print()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Notes:
<ul>
<li>when using <code>graph.stream</code>, we get an <code>event</code> dict where <code>event["messages]</code> is a list of Message objects (e.g., HumanMessage, AIMessage, etc.) on which we can call <code>pretty_print</code>, i.e., <code>event["messages"][-1].pretty_print()</code></li>
<li>when using <code>client.runs.stream</code>, we get a <code>chunk</code> object, and the data is in <code>chunk.data</code>. Furthermore, <code>chunk.data["messages"]</code> is a list of dicts on which cannot call <code>pretty_print()</code> directly, so we need to convert them first using <code>convert_to_messages</code>.</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> event <span class="kw">in</span> graph.stream(<span class="va">None</span>, to_replay.config, stream_mode<span class="op">=</span><span class="st">"values"</span>):</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    event[<span class="st">'messages'</span>][<span class="op">-</span><span class="dv">1</span>].pretty_print()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/JaumeAmoresDS\.github\.io\/data_science_raw_notes\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>